name: Deploy to EC2

on:
  push:
    branches:
      - main  # Trigger deployment when code is pushed to the main branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout Source Code
      uses: actions/checkout@v3

    - name: ðŸ” Authenticate to Docker Hub
      run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

    - name: ðŸ› ï¸ Build Docker Image
      run: docker build -t tkaushik959/my-app:latest .

    - name: ðŸ“¤ Push Docker Image to Docker Hub
      run: docker push tkaushik959/my-app:latest

    - name: ðŸ”‘ Write SSH Private Key (Correct Format)
      run: |
        printf "%s" "${{ secrets.EC2_SSH_KEY }}" > DOCKER_KEY.pem
        chmod 600 DOCKER_KEY.pem

    - name: ðŸš€ Connect to EC2 & Deploy Container
      env:
        DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
        DOCKER_PASSWORD: ${{ secrets.DOCKER_PASSWORD }}
      run: |
        ssh -o StrictHostKeyChecking=no \
            -o UserKnownHostsFile=/dev/null \
            -i DOCKER_KEY.pem \
            ubuntu@ec2-54-89-93-98.compute-1.amazonaws.com << EOF
          docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD"
          docker pull tkaushik959/my-app:latest
          docker stop my-app || true
          docker rm my-app || true
          docker run -d --name my-app -p 80:80 tkaushik959/my-app:latest
        EOF
